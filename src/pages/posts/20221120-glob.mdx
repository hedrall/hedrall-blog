---
slug: "20221120-glob"
title: "Node.jsでglobパターンを、RegExpに変換するBetterな法方"
date: 2022-11-20
author: hedrall
image: "/images/typescript/logo.png"
tags:
  - tips
  - typescript
---

小ネタです。

# 結論

以下のコードで無事、globの文字列をRegExpの文字列に変換することができました。

```typescript
const minimatch = require('minimatch').Minimatch;
const globToRegExp = glob => {
  const regexp = new minimatch(glob).makeRe();
  if (!regexp) throw new Error(`globに変換できません。glob: "${glob}"`);
  return regexp.toString().slice(1, -1); // 前後に `/` がついてしまうので、sliceする
};
```

# 解説

globをRegExpに変換する際にちょうど良いライブラリを見つけるのに時間がかかったので、本記事を書きました。

まず `glob to regexp` などで検索すると [glob-to-regexp](https://github.com/fitzgen/glob-to-regexp) のようなパッケージが出てきます。NPMでは相当なダウンロード数がありそうですが、レポはpublicアーカイブになっており、このまま利用するのも少し気が引ける状況でした。

そこで、nodeでglobを使ってファイルを読み込む際の定番ライブラリ [glob](https://github.com/isaacs/node-glob) を見てみたところ、内部的に [minimatch](https://github.com/isaacs/minimatch) というパッケージを利用して、パターンマッチさせているとの記述があります。

では、minimatchの方をみてみると、NPMパッケージ内部でglobパターンマッチに利用されており、glob文字列をJSの`RegExp`オブジェクトに変換できるという旨記載がありました。確かにNPMのライブラリをみると、[package.json](https://github.com/npm/cli/blob/dc8e6bdd1d9e3416846c4f0624705cb42a7fb067/package.json#L90) に記載されています。

以上から、Node.jsを利用する以上、NPMと同じロジックでglobを扱うのが自然と考えminimatchを利用させていただくことにしました。

minimatchの中には `makere()` という関数があり、これで `RegExp` オブジェクトを吐き出せるようです。

ちなみに、RegExpオブジェクトには`toString()`メソッドが利用できますが、`/./.toString() => '/./'`のように、前後に `/` がつくので、sliceをとってあげるようにしないと、RegExp <=> string間の相互変換は冪等な操作にならないようです。

以上、小ネタでしたが参考になれば幸いです。
